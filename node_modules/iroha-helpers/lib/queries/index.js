"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _lodash=_interopRequireDefault(require("lodash.flow")),_queryHelper=_interopRequireDefault(require("../queryHelper")),pbResponse=_interopRequireWildcard(require("../proto/qry_responses_pb")),_util=require("../util"),_validate=_interopRequireDefault(require("../validate"));function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,c):{};d.get||d.set?Object.defineProperty(b,c,d):b[c]=a[c]}return b["default"]=a,b}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var DEFAULT_OPTIONS={privateKey:"",creatorAccountId:"",queryService:null,timeoutLimit:5e3};function sendQuery(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:DEFAULT_OPTIONS,b=a.privateKey,c=a.creatorAccountId,d=a.queryService,e=a.timeoutLimit,f=1<arguments.length?arguments[1]:void 0,g=2<arguments.length&&arguments[2]!==void 0?arguments[2]:function(){};return new Promise(function(a,h){var i=d,j=(0,_lodash["default"])(function(a){return _queryHelper["default"].addMeta(a,{creatorAccountId:c})},function(a){return _queryHelper["default"].sign(a,b)})(f),k=setTimeout(function(){i.$channel.close(),h(new Error("please check IP address OR your internet connection"))},e);i.find(j,function(b,c){if(clearTimeout(k),b)return h(b);var d=c.getResponseCase(),e=(0,_util.getProtoEnumName)(pbResponse.QueryResponse.ResponseCase,"iroha.protocol.QueryResponse",d);g(a,h,e,c)})})}function getAccount(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getAccount",(0,_validate["default"])(b,["accountId"])),function(a,b,c,d){if("ACCOUNT_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ACCOUNT_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getAccountResponse().getAccount().toObject();a(e)})}function getRawAccount(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getAccount",(0,_validate["default"])(b,["accountId"])),function(a,b,c,d){if("ACCOUNT_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ACCOUNT_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getAccountResponse();a(e)})}function getSignatories(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getSignatories",(0,_validate["default"])(b,["accountId"])),function(a,b,c,d){if("SIGNATORIES_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=SIGNATORIES_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getSignatoriesResponse().toObject().keysList;a(e)})}function getTransactions(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getTransactions",(0,_validate["default"])(b,["txHashesList"])),function(a,b,c,d){if("TRANSACTIONS_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=TRANSACTIONS_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getTransactionsResponse();a(e)})}function getPendingTransactions(a){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getPendingTransactions",{}),function(a,b,c,d){if("TRANSACTIONS_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=TRANSACTIONS_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getTransactionsResponse().toObject().transactionsList;a(e)})}function getRawPendingTransactions(a){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getPendingTransactions",{}),function(a,b,c,d){if("TRANSACTIONS_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=TRANSACTIONS_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getTransactionsResponse();a(e)})}function getAccountTransactions(a,b){var c=b.accountId,d=b.pageSize,e=b.firstTxHash;return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getAccountTransactions",{accountId:c,paginationMeta:{pageSize:d,firstTxHash:e}}),function(a,b,c,d){if("TRANSACTIONS_PAGE_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=TRANSACTIONS_PAGE_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getTransactionsPageResponse().toObject();a(e)})}function getAccountAssetTransactions(a,b){var c=b.accountId,d=b.assetId,e=b.pageSize,f=b.firstTxHash;return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"GetAccountAssetTransactions",{accountId:c,assetId:d,paginationMeta:{pageSize:e,firstTxHash:f}}),function(a,b,c,d){if("TRANSACTIONS_PAGE_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=TRANSACTIONS_PAGE_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getTransactionsPageResponse().toObject();a(e)})}function getAccountAssets(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getAccountAssets",(0,_validate["default"])(b,["accountId"])),function(a,b,c,d){if("ACCOUNT_ASSETS_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ACCOUNT_ASSETS_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getAccountAssetsResponse().toObject().accountAssetsList;a(e)})}function getAccountDetail(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getAccountDetail",(0,_validate["default"])(b,["accountId","key","writer"])),function(a,b,c,d){if("ACCOUNT_DETAIL_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ACCOUNT_DETAIL_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=JSON.parse(d.getAccountDetailResponse().toObject().detail);a(e)})}function getAssetInfo(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getAssetInfo",(0,_validate["default"])(b,["assetId"])),function(a,b,c,d){if("ASSET_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ASSET_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getAssetResponse().toObject().asset;a(e)})}function getRoles(a){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getRoles",{}),function(a,b,c,d){if("ROLES_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ROLES_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getRolesResponse().toObject().rolesList;a(e)})}function getRolePermissions(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getRolePermissions",(0,_validate["default"])(b,["roleId"])),function(a,b,c,d){if("ROLE_PERMISSIONS_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=ROLE_PERMISSIONS_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getRolePermissionsResponse().toObject().permissionsList;a(e)})}function getBlock(a,b){return sendQuery(a,_queryHelper["default"].addQuery(_queryHelper["default"].emptyQuery(),"getBlock",(0,_validate["default"])(b,["height"])),function(a,b,c,d){if("BLOCK_RESPONSE"!==c){var f=JSON.stringify(d.toObject().errorResponse);return b(new Error("Query response error: expected=BLOCK_RESPONSE, actual=".concat(c,"\nReason: ").concat(f)))}var e=d.getBlockResponse().toObject().block.blockV1;a(e)})}function fetchCommits(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:DEFAULT_OPTIONS,b=a.privateKey,c=a.creatorAccountId,d=a.queryService,e=1<arguments.length&&arguments[1]!==void 0?arguments[1]:function(){},f=2<arguments.length&&arguments[2]!==void 0?arguments[2]:function(){},g=_queryHelper["default"].emptyBlocksQuery(),h=(0,_lodash["default"])(function(a){return _queryHelper["default"].addMeta(a,{creatorAccountId:c})},function(a){return _queryHelper["default"].sign(a,b)})(g),i=d.fetchCommits(h);i.on("data",function(a){var b=a.getResponseCase(),c=(0,_util.getProtoEnumName)(pbResponse.BlockQueryResponse.ResponseCase,"iroha.protocol.BlockQueryResponse",b);if("BLOCK_RESPONSE"!==c){var d=JSON.stringify(a.toObject().blockErrorResponse);f(new Error("Query response error: expected=BLOCK_RESPONSE, actual=".concat(c,"\nReason: ").concat(d)))}else{var g=a.toObject().blockResponse.block;e(g)}})}var _default={getAccount:getAccount,getRawAccount:getRawAccount,getSignatories:getSignatories,getTransactions:getTransactions,getPendingTransactions:getPendingTransactions,getRawPendingTransactions:getRawPendingTransactions,getAccountTransactions:getAccountTransactions,getAccountAssetTransactions:getAccountAssetTransactions,getAccountAssets:getAccountAssets,getAccountDetail:getAccountDetail,getAssetInfo:getAssetInfo,getRoles:getRoles,getRolePermissions:getRolePermissions,getBlock:getBlock,fetchCommits:fetchCommits};exports["default"]=_default;