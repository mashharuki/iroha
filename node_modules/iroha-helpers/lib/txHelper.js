"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0,require("@babel/polyfill");var _buffer=require("buffer"),_ed=require("ed25519.js"),_jsSha=require("js-sha3"),_lodash=_interopRequireDefault(require("lodash.clonedeep")),Commands=_interopRequireWildcard(require("./proto/commands_pb")),_endpoint_pb=require("./proto/endpoint_pb"),_primitive_pb=require("./proto/primitive_pb"),_transaction_pb=_interopRequireDefault(require("./proto/transaction_pb")),_util=require("./util.js");function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,c):{};d.get||d.set?Object.defineProperty(b,c,d):b[c]=a[c]}return b["default"]=a,b}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}var emptyTransaction=function(){return new _transaction_pb["default"].Transaction},getOrCreatePayload=function(a){return a.hasPayload()?(0,_lodash["default"])(a.getPayload()):new _transaction_pb["default"].Transaction.Payload},getOrCreateReducedPayload=function(a){return a.hasReducedPayload()?(0,_lodash["default"])(a.getReducedPayload()):new _transaction_pb["default"].Transaction.Payload.ReducedPayload},addCommand=function(a,b,c){for(var d=new Commands[(0,_util.capitalize)(b)],e=0,f=Object.entries(c);e<f.length;e++){var g=_slicedToArray(f[e],2),h=g[0],i=g[1];if("setPeer"=="set"+(0,_util.capitalize)(h)){var o=new Commands.Peer;o.setAddress(i.address),o.setPeerKey(i.peerKey),d["set"+(0,_util.capitalize)(h)](o)}else d["set"+(0,_util.capitalize)(h)](i)}var j=new Commands.Command,k="set"+(0,_util.capitalize)(b);j[k](d);var l=getOrCreatePayload(a),m=getOrCreateReducedPayload(l);m.addCommands(j,m.getCommandsList.length),l.setReducedPayload(m);var n=(0,_lodash["default"])(a);return n.setPayload(l),n},addMeta=function(a,b){var c=b.creatorAccountId,d=b.createdTime,e=void 0===d?Date.now():d,f=b.quorum,g=void 0===f?1:f,h=getOrCreatePayload(a),i=getOrCreateReducedPayload(h);i.setCreatorAccountId(c),i.setCreatedTime(e),i.setQuorum(g),h.setReducedPayload(i);var j=(0,_lodash["default"])(a);return j.setPayload(h),j},sign=function(a,b){var c=_buffer.Buffer.from(b,"hex"),d=(0,_ed.derivePublicKey)(c),e=hash(a),f=(0,_ed.sign)(e,d,c),g=new _primitive_pb.Signature;g.setPublicKey(d.toString("hex")),g.setSignature(f.toString("hex"));var h=(0,_lodash["default"])(a);return h.addSignatures(g,h.getSignaturesList.length),h},hash=function(a){return _buffer.Buffer.from(_jsSha.sha3_256.array(a.getPayload().serializeBinary()))},addBatchMeta=function(a,b){var c=a.map(function(a){return(0,_jsSha.sha3_256)(a.getPayload().getReducedPayload().serializeBinary())}),d=new _transaction_pb["default"].Transaction.Payload.BatchMeta;d.setReducedHashesList(c),d.setType(b);var e=a.map(function(a){var b=(0,_lodash["default"])(a),c=getOrCreatePayload(b);return c.setBatch(d),b.setPayload(c),b});return e},createTxListFromArray=function(a){var b=new _endpoint_pb.TxList;return b.setTransactionsList(a),b},_default={addCommand:addCommand,addMeta:addMeta,sign:sign,emptyTransaction:emptyTransaction,hash:hash,addBatchMeta:addBatchMeta,createTxListFromArray:createTxListFromArray};exports["default"]=_default;