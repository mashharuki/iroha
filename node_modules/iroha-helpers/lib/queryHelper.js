"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _buffer=require("buffer"),_ed=require("ed25519.js"),_jsSha=require("js-sha3"),_lodash=_interopRequireDefault(require("lodash.clonedeep")),_primitive_pb=require("./proto/primitive_pb"),Queries=_interopRequireWildcard(require("./proto/queries_pb")),_util=require("./util.js");function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,c):{};d.get||d.set?Object.defineProperty(b,c,d):b[c]=a[c]}return b["default"]=a,b}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}var emptyQuery=function(){return new Queries.Query},emptyBlocksQuery=function(){return new Queries.BlocksQuery},getOrCreatePayload=function(a){return a.hasPayload()?(0,_lodash["default"])(a.getPayload()):new Queries.Query.Payload},addQuery=function(a,b,c){for(var d=new Queries[(0,_util.capitalize)(b)],e=0,f=Object.entries(c);e<f.length;e++){var g=_slicedToArray(f[e],2),h=g[0],i=g[1],j="set".concat((0,_util.capitalize)(h));if("setPaginationMeta"===j){var m=new Queries.TxPaginationMeta;m.setPageSize(i.pageSize),m.setFirstTxHash(i.firstTxHash),d[j](m)}else d[j](i)}var k=getOrCreatePayload(a);k["set"+(0,_util.capitalize)(b)](d);var l=(0,_lodash["default"])(a);return l.setPayload(k),l},addMeta=function(a,b){var c=b.creatorAccountId,d=b.createdTime,e=void 0===d?Date.now():d,f=b.queryCounter,g=void 0===f?1:f,h=new Queries.QueryPayloadMeta;h.setCreatorAccountId(c),h.setCreatedTime(e),h.setQueryCounter(g);var i=(0,_lodash["default"])(a);if(a instanceof Queries.Query){var j=getOrCreatePayload(a);j.setMeta(h),i.setPayload(j)}else if(a instanceof Queries.BlocksQuery)i.setMeta(h);else throw new Error("Unknown query type");return i},sign=function(a,b){var c=_buffer.Buffer.from(b,"hex"),d=(0,_ed.derivePublicKey)(c),e=null;if(a instanceof Queries.Query)e=a.getPayload();else if(a instanceof Queries.BlocksQuery)e=a.getMeta();else throw new Error("Unknown query type");var f=_buffer.Buffer.from(_jsSha.sha3_256.array(e.serializeBinary())),g=(0,_ed.sign)(f,d,c),h=new _primitive_pb.Signature;h.setPublicKey(d.toString("hex")),h.setSignature(g.toString("hex"));var i=(0,_lodash["default"])(a);return i.setSignature(h),i},_default={sign:sign,addMeta:addMeta,addQuery:addQuery,emptyQuery:emptyQuery,emptyBlocksQuery:emptyBlocksQuery};exports["default"]=_default;