"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getProtoEnumName=getProtoEnumName,exports.sendTransactions=sendTransactions,exports.signWithArrayOfKeys=signWithArrayOfKeys,exports.capitalize=void 0;var _txHelper=_interopRequireDefault(require("./txHelper")),_endpoint_pb=require("./proto/endpoint_pb");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _listToTorii(a,b,c){var d=_txHelper["default"].createTxListFromArray(a);return new Promise(function(e,f){var g=setTimeout(function(){b.$channel.close(),f(new Error("Please check IP address OR your internet connection"))},c);b.listTorii(d,function(b){if(clearTimeout(g),b)return f(b);var c=a.map(function(a){return _txHelper["default"].hash(a)});e(c)})})}function _handleStream(a,b){var c=new _endpoint_pb.TxStatusRequest;return c.setTxHash(a.toString("hex")),b.statusStream(c)}function _fromStream(a,b){var c=a.hash,d=a.txClient,e=[_endpoint_pb.TxStatus.STATELESS_VALIDATION_FAILED,_endpoint_pb.TxStatus.STATEFUL_VALIDATION_FAILED,_endpoint_pb.TxStatus.COMMITTED,_endpoint_pb.TxStatus.NOT_RECEIVED,_endpoint_pb.TxStatus.REJECTED],f=b.map(function(a){return _endpoint_pb.TxStatus[a]}),g=[_endpoint_pb.TxStatus.COMMITTED].concat(_toConsumableArray(f)),h=function(a){return e.includes(a)},i=function(a){return f.includes(a)},j=function(a){return!g.includes(a)};return new Promise(function(a){var b,e=function(){var a=_handleStream(c,d);a.on("data",g)},f=function(){clearTimeout(b),b=setTimeout(e,5e3)},g=function(c){f();var d=c.getTxStatus();(h(d)||i(d))&&(clearTimeout(b),a({tx:c,error:j(d)}))};e()})}function _streamVerifier(){return _streamVerifier2.apply(this,arguments)}function _streamVerifier2(){return _streamVerifier2=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c,d){var e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,_fromStream({hash:b,txClient:c},d);case 2:return e=a.sent,a.abrupt("return",e);case 4:case"end":return a.stop();}},a)})),_streamVerifier2.apply(this,arguments)}var capitalize=function(a){return a.charAt(0).toUpperCase()+a.slice(1)};exports.capitalize=capitalize;var protoEnumName={};function getProtoEnumName(a,b,c){if(protoEnumName.hasOwnProperty(b))return protoEnumName[b].length<c?"unknown":protoEnumName[b][c];for(var d in protoEnumName[b]=[],a){var e=a[d];if(isNaN(e))throw Error("getProtoEnumName:wrong enum value, now is type of ".concat(_typeof(e)," should be integer"));else protoEnumName[b][e]=d}return getProtoEnumName(a,b,c)}function sendTransactions(a,b,c){var d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:["COMMITTED"];return _listToTorii(a,b,c).then(function(a){return new Promise(function(c,e){var f=a.map(function(a){return _streamVerifier(a,b,d)});Promise.all(f).then(function(a){var b=a.map(function(a){return getProtoEnumName(_endpoint_pb.TxStatus,"iroha.protocol.TxStatus",a.tx.getTxStatus())});return a.some(function(a){return a.error})?e(new Error("Command response error: expected=".concat(d,", actual=").concat(b))):c()})})})}function signWithArrayOfKeys(a,b){return b.forEach(function(b){a=_txHelper["default"].sign(a,b)}),a}